<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sifang.insurance.calculator.mapper.CalculationRuleMapper">

    <resultMap id="BaseResultMap" type="com.sifang.insurance.calculator.entity.CalculationRule">
        <id column="id" property="id"/>
        <result column="rule_name" property="ruleName"/>
        <result column="rule_code" property="ruleCode"/>
        <result column="product_id" property="productId"/>
        <result column="product_type" property="productType"/>
        <result column="calculation_method" property="calculationMethod"/>
        <result column="base_rate" property="baseRate"/>
        <result column="min_premium" property="minPremium"/>
        <result column="max_premium" property="maxPremium"/>
        <result column="rule_content" property="ruleContent"/>
        <result column="status" property="status"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="create_by" property="createBy"/>
        <result column="update_by" property="updateBy"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <sql id="Base_Column_List">
        id, rule_name, rule_code, product_id, product_type, calculation_method, 
        base_rate, min_premium, max_premium, rule_content, status, 
        create_time, update_time, create_by, update_by, remark
    </sql>

    <select id="selectEnabledRulesByProductId" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM calculation_rule
        WHERE product_id = #{productId}
        AND status = 1
        ORDER BY update_time DESC
    </select>

    <select id="selectByRuleCode" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM calculation_rule
        WHERE rule_code = #{ruleCode}
    </select>

    <select id="selectRulesByProductType" resultMap="BaseResultMap">
        SELECT
        <include refid="Base_Column_List"/>
        FROM calculation_rule
        WHERE product_type = #{productType}
        ORDER BY status DESC, update_time DESC
    </select>

    <update id="updateRuleStatus">
        UPDATE calculation_rule
        SET status = #{status},
            update_time = NOW()
        WHERE id = #{id}
    </update>
</mapper>